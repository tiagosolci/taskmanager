<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl">
  <title data-ice="title">Home | task-manager</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#erros">erros</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/CampoDuplicado.js~CampoDuplicado.html">CampoDuplicado</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/CampoInvalido.js~CampoInvalido.html">CampoInvalido</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/FalhaAutenticacao.js~FalhaAutenticacao.html">FalhaAutenticacao</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/ProjetoNaoEncontrado.js~ProjetoNaoEncontrado.html">ProjetoNaoEncontrado</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/TarefaNaoEncontrada.js~TarefaNaoEncontrada.html">TarefaNaoEncontrada</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/TokenInvalido.js~TokenInvalido.html">TokenInvalido</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/TokenInvalidoPorLogout.js~TokenInvalidoPorLogout.html">TokenInvalidoPorLogout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/TokenNaoEnviado.js~TokenNaoEnviado.html">TokenNaoEnviado</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/erros/UsuarioNaoEncontrado.js~UsuarioNaoEncontrado.html">UsuarioNaoEncontrado</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#middlewares">middlewares</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-criarConfiguracaoEmail">criarConfiguracaoEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificaSenha">verificaSenha</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificaUsuario">verificaUsuario</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gerarTokenJWT">gerarTokenJWT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-gerarTokenOpaco">gerarTokenOpaco</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-invalidaTokenJWT">invalidaTokenJWT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-invalidaTokenOpaco">invalidaTokenOpaco</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificaTokenJWT">verificaTokenJWT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificaTokenNaBlockList">verificaTokenNaBlockList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificaTokenOpaco">verificaTokenOpaco</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-configuracaoEmailProducao">configuracaoEmailProducao</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nodemailer">nodemailer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Email">Email</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BearerStrategy">BearerStrategy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FalhaAutenticacao">FalhaAutenticacao</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LocalStrategy">LocalStrategy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Usuario">Usuario</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bcrypt">bcrypt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-passport">passport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tokens">tokens</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-passport">passport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-jwt">jwt</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#models">models</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fs">fs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Model">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Model">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Model">Model</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#rotas-projetos">rotas/projetos</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/rotas/projetos/Projeto.js~Projeto.html">Projeto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verificarProjeto">verificarProjeto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-roteadorTarefas">roteadorTarefas</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#rotas-projetos-tarefas">rotas/projetos/tarefas</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/rotas/projetos/tarefas/Tarefa.js~Tarefa.html">Tarefa</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#rotas-usuarios">rotas/usuarios</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/rotas/usuarios/Usuario.js~Usuario.html">Usuario</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#services">services</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/services/ProjetosService.js~ProjetosService.html">ProjetosService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/services/TarefasService.js~TarefasService.html">TarefasService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/api/services/UsuariosService.js~UsuariosService.html">UsuariosService</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><div data-ice="index" class="github-markdown"><h1 id="task-manager">Task Manager</h1><h2 id="uma-aplica&#xE7;&#xE3;o-web-para-gerenciar-tarefas-de-multi-usu&#xE1;rios">Uma aplica&#xE7;&#xE3;o web para gerenciar tarefas de multi-usu&#xE1;rios</h2><p><a name="sobre"></a></p>
<h2 id="sobre">Sobre</h2><p>A aplica&#xE7;&#xE3;o &#xE9; a soluc&#xE3;o do autor para um desafio de cria&#xE7;&#xE3;o de um gerenciador de tarefas.</p>
<p><a name="tabela-de-conteudo"></a></p>
<h2 id="tabela-de-conte&#xFA;dos">Tabela de conte&#xFA;dos</h2><ul>
<li><a href="#sobre">Sobre</a></li>
<li><a href="#tabela-de-conteudo">Tabela de Conteudo</a></li>
<li><a href="#tecnologias">Tecnologias</a></li>
<li><a href="#instalacao">Instala&#xE7;&#xE3;o</a></li>
<li><a href="#licenca">Licen&#xE7;a</a></li>
</ul>
<p><a name="tecnologias"></a></p>
<h2 id="tecnologias">Tecnologias</h2><p>As seguintes ferramentas foram usadas na constru&#xE7;&#xE3;o do projeto:</p>
<ul>
<li><a href="http://angularjs.org">AngularJS</a> </li>
<li><a href="http://nodejs.org">node.js</a></li>
<li><a href="http://expressjs.com">Express</a></li>
<li><a href="https://www.mysql.com">Mysql</a></li>
<li>[Sequelize]</li>
</ul>
<p><a name="instalacao"></a></p>
<h2 id="instala&#xE7;&#xE3;o">Instala&#xE7;&#xE3;o</h2><p>Taskmanager requer <a href="https://nodejs.org/">Node.js</a> v10+ para rodar.</p>
<p>Os modelos usados pela aplica&#xE7;&#xE3;o foram criados atrav&#xE9;s do Sequelize, aperfei&#xE7;oando a implementa&#xE7;&#xE3;o do DB. Dessa forma essa nova vers&#xE3;o possui ORM que era uma car&#xEA;ncia da primeira vers&#xE3;o.</p>
<p>Assim, desse momento em diante todas as altera&#xE7;&#xF5;es no DB ser&#xE3;o incrementais e poder&#xE3;o ser rastreadas. Sendo poss&#xED;vel coordernar as altera&#xE7;&#xF5;es feitas por diferentes pessoas nas tabelas do banco como rastrear (e reverter) altera&#xE7;&#xF5;es feitas no banco se for preciso.</p>
<p>O Usu&#xE1;rio &#xE9; uma classe com todas as fun&#xE7;&#xF5;es para manipular um usu&#xE1;rio.</p>
<ul>
<li>Para criar um usu&#xE1;rio a classe &#xE9; instanciada e o m&#xE9;todo criar &#xE9; invocado, ela valida os campos obrigat&#xF3;rios e inst&#xE2;ncia o modelo do sequelize para a inser&#xE7;&#xE3;o no banco.</li>
<li>Al&#xE9;m da valida&#xE7;&#xE3;o &#xE9; checado se o campo senha tem no min&#xED;mo 8 caracteres e no m&#xE1;ximo 64 caracteres, caso positivo &#xE9; gerado um hash da senha com o m&#xF3;dulo do node bcrypt, assim a senha digitada pelo usu&#xE1;rio n&#xE3;o ser&#xE1; gravada no banco.</li>
<li>O modelo Usu&#xE1;rios do sequelize al&#xE9;m de validar a obrigatoriedade dos campos, para respeitar a regra de neg&#xF3;cio mesmo que o m&#xE9;todo seja invocado por outra rota, verifica se o e-mail &#xE9; v&#xE1;lido e se ele j&#xE1; foi cadastrado. Caso j&#xE1; tenha sido cadastrado o erro &#xE9; tratado pelo middleware e pela classe de erro CampoDuplicado.
(enviado e-mail de confirma&#xE7;&#xE3;o da conta para o e-mail cadastrado, middlewares e tokens s&#xE3;o utilizados para criar um token com o id do usu&#xE1;rio para verificar o endere&#xE7;o de e-mail do usu&#xE1;rio)</li>
<li>A requisi&#xE7;&#xE3;o encerra com status 201 e a mensagem de que o usu&#xE1;rio foi criado com sucesso.</li>
</ul>
<p>Para configura&#xE7;&#xE3;o da estrat&#xE9;gia local de autentica&#xE7;&#xE3;o do usu&#xE1;rio foi usado o m&#xF3;dulo node passport e passport-local
A configura&#xE7;&#xE3;o foi concentrada no middleware estrategiaAutenticacao.</p>
<ul>
<li>Em estrategiaAutenticacao, o passport &#xE9; configurado e a estrat&#xE9;gia local &#xE9; configurada.</li>
<li>A classe Usu&#xE1;rio &#xE9; instanciada e &#xE9; feito a busca do registro do usu&#xE1;rio pelo e-mail informado no login, caso retorno nulo a estrat&#xE9;gia devolve o erro de que o usu&#xE1;rio n&#xE3;o foi localizado.</li>
<li>Encontrado o usu&#xE1;rio a senha informada &#xE9; validada com hash da senha salvo no DB atrav&#xE9;s do m&#xE9;todo compare do bcrypt.</li>
<li>Confirmado que a senha &#xE9; a correta o middleware passa o usu&#xE1;rio localizado para o pr&#xF3;ximo middleware.</li>
</ul>
<p>Quando a autentica&#xE7;&#xE3;o &#xE9; bem sucedida, a requisi&#xE7;&#xE3;o de login recebe os dados de usu&#xE1;rio e gera um jwt com o id que &#xE9; devolvido no header (&apos;Authorization) da resposta da chamada.</p>
<p>Para gerar a senha que assina o jwt, fazendo uso do console, foi executado  comando:  </p>
<ul>
<li><p>node -e &quot;console.log(require(&apos;crypto&apos;).randomBytes(256).toString(&apos;base64&apos;))&quot;</p>
</li>
<li><p>Onde invocamos o m&#xF3;dulo crypto e chamamos o m&#xE9;todo para criar bytes pseudo-aleat&#xF3;rios e convertemos o resultado para uma string na base 64.</p>
</li>
<li><p>Essa senha foi ent&#xE3;o adicionada ao arquivo .env na raiz do projeto, sobre o par&#xE2;metro CHAVE_JWT.</p>
</li>
<li><p>Para acessar esse par&#xE2;metro, &#xE9; utilizado o m&#xF3;dulo dotenv e assim, atrav&#xE9;s de process.env.CHAVE_JWT a senha &#xE9; utilizada para assinar o token.</p>
</li>
</ul>
<p>Obs. O correto &#xE9; adicionar o .env ao .gitignore para prote&#xE7;&#xE3;o da assinatura do token mas como o objetivo desse projeto &#xE9; apresentar a solu&#xE7;&#xE3;o completa, foi feita a op&#xE7;&#xE3;o por publicar o item para consulta de seu cont&#xE9;udo.</p>
<p>Para receber e validar o token nas rotas que precisam de autentica&#xE7;&#xE3;o, foi utilizado o m&#xF3;dulo passport-http-bearer e feita a sua configura&#xE7;&#xE3;o no middleware de estrategiaAutenticacao, como estrat&#xE9;gia &apos;bearer&apos;:</p>
<ul>
<li>A estrat&#xE9;gia faz uso do m&#xE9;todo do m&#xF3;dulo jwt verify para validar o token enviado, a v&#xE1;riavel de ambiente CHAVE_JWT &#xE9; utilizada.</li>
<li>O resultado da verifica&#xE7;&#xE3;o &#xE9; atribu&#xED;do a constante payload com o id do usu&#xE1;rio.</li>
<li>Criamos uma nova inst&#xE2;ncia da classe Usu&#xE1;rio e passamos o id para o construtor;</li>
<li>Em seguida o m&#xE9;todo buscarPorId() &#xE9; invocado;</li>
<li><p>Encontrado o usu&#xE1;rio o middleware passa o usu&#xE1;rio localizado para o pr&#xF3;ximo middleware.</p>
<p>Para fazer uso da estrat&#xE9;gia nas rotas que devem ser protegidas, basta adicionar o middleware como no exemplo a abaixo:
router.post(&apos;/rota_com_autentica&#xE7;&#xE3;o/&apos;, passport.authenticate(&apos;bearer&apos;, { session: false }), (req, res, next) =&gt; {</p>
</li>
</ul>
<p>Ap&#xF3;s a implementa&#xE7;&#xE3;o da estrat&#xE9;gia, foi criado um middleware de autentica&#xE7;&#xE3;o para tratar e formatar erros gerados pela valida&#xE7;&#xE3;o do passport.</p>
<p>Para gerir o processo de logout foi preciso criar uma blacklist, foi utilizado o m&#xF3;dulo redis para isso.
Criamos o cliente redis para a blacklist na pasta redis na raiz do projeto.
Depois foi criada a classe que &#xE9; respons&#xE1;vel por adicionar e verificar a exist&#xEA;ncia de tokens na lista.
Feito isso, foi criada a rota de logout e adicionamos o token jwt fazendo o uso da classe ManipulaBlacklist.
Depois disso na estrat&#xE9;gia bearer adicionamos a verifica&#xE7;&#xE3;o na backlist para verificar se o token da requisi&#xE7;&#xE3;o est&#xE1; na blacklist.
Foi criado a classe para tratar o erro quando o token foi inv&#xE1;lidado por logout.</p>
<p>Como o JWT tem um tempo de expira&#xE7;&#xE3;o de 15 minutos, ser&#xE1; necess&#xE1;rio implementar um refresh token e tamb&#xE9;m uma allowlist.
Para trabalhar com as diferentes listas no redis, foi criada uma interface gen&#xE9;rica.
Assim blocklist e allowlist podem trabalhar as diferentes regras de neg&#xF3;cio e fazer as opera&#xE7;&#xF5;es necess&#xE1;rias nas listas.</p>
<p>Interface tokens concentrando e abstraindo todas as opera&#xE7;&#xF5;es com tokens</p>
<p>Para a documenta&#xE7;&#xE3;o foi utilizado o m&#xF3;dulo esDoc, 
Assim que o m&#xF3;dulo &#xE9; instalado, rodei o comando abaixo no terminal, de acordo com a documenta&#xE7;&#xE3;o do plugin.
echo &apos;{
  &quot;source&quot;: &quot;./src&quot;,
  &quot;destination&quot;: &quot;./docs&quot;,
  &quot;plugins&quot;: [{&quot;name&quot;: &quot;esdoc-standard-plugin&quot;}]
}&apos; &gt; .esdoc.json</p>
<p>ap&#xF3;s isso, editei o arquivo criado para as particularidades do projeto:</p>
<p>{
  &quot;source&quot;: &quot;./api&quot;,
  &quot;destination&quot;: &quot;./docs&quot;,
  &quot;plugins&quot;: [
    {
      &quot;name&quot;: &quot;esdoc-standard-plugin&quot;,
      &quot;option&quot;: {
        &quot;undocumentIdentifier&quot;: {
          &quot;enable&quot;: false
        },
        &quot;unexportedIdentifier&quot;: {
          &quot;enable&quot;: true
        }
      }
    }
  ]
}</p>
<p>E para atualizar a documenta&#xE7;&#xE3;o quando necess&#xE1;rio, bastou rodar o comando abaixo:
./node_modules/.bin/esdoc</p>
<p>Instale as depend&#xEA;ncias e as devDependencies e inicie o servidor.</p>
<pre><code class="lang-sh"><code class="source-code prettyprint">cd taskmanager
npm i
npm start</code>
</code></pre>
<p><a name="licenca"></a></p>
<h2 id="licen&#xE7;a">Licen&#xE7;a</h2><p>MIT</p>
</div>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
